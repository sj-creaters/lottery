<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>抽選アニメーション</title>
  <style>
    /* body背景は config で設定される */
    body {
      margin: 0;
      padding: 0;
    }
    /* タイトルエリア */
    #pageTitle {
      text-align: center;
      font-size: 28px;
      margin: 20px 0;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
    }
    /* 中央画像コンテナ */
    .center-container {
      position: relative;
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
      overflow: hidden;
    }
    #centerImage {
      width: 100%;
      height: auto;
      display: block;
    }
    /* 賞タイルオーバーレイ：CSS Grid で配置 */
    .prizes-overlay {
      position: absolute;
      top: 30%;
      left: 0;
      right: 0;
      bottom: 30%;
      display: grid;
      gap: 10px;
      pointer-events: none;
      padding: 10px;
      box-sizing: border-box;
      /* 1行あたり3列に固定（賞の数が少ない場合はその数に合わせる） */
      grid-template-columns: repeat(3, 1fr);
      justify-items: center;
      align-items: center;
      justify-content: center;
    }
    /* 賞タイル：横幅90%、flexで中央寄せ（ただし、後から JS で調整） */
    .tile {
      width: 97%;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      border: 2px solid #aaa;
      font-size: 14px;
      font-family: 'Arial Black', Gadget, sans-serif;
      font-weight: bold;
      border-radius: 8px;
      transition: background-color 0.2s;
      background-color: rgba(255, 255, 255, 0.95);
      color: #333;
      box-sizing: border-box;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      /* 初期は中央 */
      text-align: center;
    }
    /* active 状態 */
    .active {
      background-color: yellow;
      border-color: orange;
    }
    /* winner 状態 */
    .winner {
      background-color: magenta;
      border-color: red;
      color: white;
    }
    button {
      font-size: 16px;
      padding: 8px 16px;
      margin: 10px;
    }
    @media (max-width: 768px) {
      .tile {
        font-size: 14px;
      }
    }
    @media (max-width: 480px) {
      .tile {
        font-size: 12px;
      }
      button {
        font-size: 14px;
        padding: 6px 12px;
        margin: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- タイトルエリア -->
  <div id="pageTitle"></div>
  
  <!-- 中央画像コンテナ -->
  <div class="center-container" id="centerContainer">
    <img id="centerImage" src="" alt="中央画像">
    <!-- 賞タイルオーバーレイ -->
    <div id="tilesOverlay" class="prizes-overlay">
      <!-- 賞タイルが動的に生成されます -->
    </div>
  </div>
  
  <div style="text-align: center;">
    <button id="startBtn">スタート</button>
  </div>
  
  <div id="resultMessage" style="text-align: center; font-size: 20px; margin-top: 10px;"></div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
    import { 
      getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, getDocs, addDoc 
    } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyA50uDr4LVMasAode1in9l07O5DABh4DzU",
      authDomain: "lottery-15223.firebaseapp.com",
      projectId: "lottery-15223",
      storageBucket: "lottery-15223.firebasestorage.app",
      messagingSenderId: "82082482343",
      appId: "1:82082482343:web:af3a3bbcd6d0740078f382",
      measurementId: "G-Z9C5H639G1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Load Display 設定
    const configDocRef = doc(db, "displaySettings", "config");
    async function loadDisplayConfig() {
      const docSnap = await getDoc(configDocRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        const titleVisible = data.titleVisible === undefined ? true : data.titleVisible;
        const titleText = data.title || "";
        const titleElem = document.getElementById("pageTitle");
        if (titleVisible && titleText) {
          titleElem.textContent = titleText;
          titleElem.style.display = "block";
        } else {
          titleElem.style.display = "none";
        }
        const currentBgImageUrl = data.currentBgImageUrl || "";
        if (currentBgImageUrl) {
          document.body.style.backgroundImage = url('${currentBgImageUrl}');
          document.body.style.backgroundRepeat = "repeat";
        } else {
          document.body.style.backgroundImage = "";
        }
        const currentCenterImageUrl = data.currentCenterImageUrl || "";
        const centerImageElem = document.getElementById("centerImage");
        if (currentCenterImageUrl) {
          centerImageElem.src = currentCenterImageUrl;
        } else {
          centerImageElem.src = "";
        }
      }
    }
    loadDisplayConfig();
    
    // 賞情報取得＆タイル生成
    const tilesOverlay = document.getElementById("tilesOverlay");
    let prizesList = [];
    const prizesQuery = query(collection(db, "prizes"), orderBy("rank", "asc"));
    onSnapshot(prizesQuery, (snapshot) => {
      prizesList = [];
      tilesOverlay.innerHTML = "";
      snapshot.forEach(docSnap => {
        const prize = docSnap.data();
        prize.id = docSnap.id;
        prizesList.push(prize);
      });
      // 固定列数: 1行に3個配置（賞が3個未満ならその数）
      let colCount = prizesList.length >= 3 ? 3 : prizesList.length;
      tilesOverlay.style.gridTemplateColumns = repeat(${colCount}, 1fr);
      prizesList.forEach(prize => {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.textContent = prize.name;
        tile.dataset.id = prize.id;
        tilesOverlay.appendChild(tile);
        // 文字配置の調整：もしテキストが溢れる場合、左寄せにする
        // ※ レイアウト後にチェックするため、setTimeoutを使用
        setTimeout(() => {
          if (tile.scrollWidth > tile.clientWidth) {
            tile.style.textAlign = "left";
          } else {
            tile.style.textAlign = "center";
          }
        }, 0);
      });
    });
    
    // BEEP 音再生
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep() {
      if (audioCtx.state === "suspended") { audioCtx.resume(); }
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.type = "square";
      oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.1);
    }
    
    // アニメーション処理設定
    let running = false;
    let currentDelay = 100;
    let deceleration = 20; // 通常の減速係数
    // 通常は maxDelay 500, 但し当選賞が "A" の場合は中間値 550
    let maxDelay = 500;
    let timerId;
    let prevIndex = -1;
    let preselectedWinner = null;
    let startTime = 0;
    
    function clearActive() {
      document.querySelectorAll('.tile').forEach(tile => {
        tile.classList.remove('active');
        tile.classList.remove('winner');
      });
    }
    
    function getRandomIndex(max, exclude) {
      if (max <= 1) return 0;
      let idx;
      do {
        idx = Math.floor(Math.random() * max);
      } while (idx === exclude);
      return idx;
    }
    
    // 重み付け抽選：履歴から各賞の残数を計算
    async function preselectWinner() {
      const historySnapshot = await getDocs(collection(db, "history"));
      const historyCounts = {};
      historySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.prizeId) {
          historyCounts[data.prizeId] = (historyCounts[data.prizeId] || 0) + 1;
        }
      });
      let weightedPrizes = [];
      let totalWeight = 0;
      prizesList.forEach(prize => {
        const drawnCount = historyCounts[prize.id] || 0;
        const remaining = prize.quantity - drawnCount;
        if (remaining > 0) {
          weightedPrizes.push({ prize: prize, weight: remaining });
          totalWeight += remaining;
        }
      });
      if (totalWeight <= 0) {
        preselectedWinner = null;
      } else {
        let randomNum = Math.random() * totalWeight;
        for (let item of weightedPrizes) {
          randomNum -= item.weight;
          if (randomNum <= 0) {
            preselectedWinner = item.prize;
            break;
          }
        }
      }
    }
    
    // アニメーション処理（ランダム点滅）
    function animate() {
      const tiles = document.querySelectorAll('.tile');
      if (tiles.length === 0) { running = false; return; }
      clearActive();
      const randomIndex = getRandomIndex(tiles.length, prevIndex);
      tiles[randomIndex].classList.add('active');
      prevIndex = randomIndex;
      beep();
      // 自動停止仕様：スタート後3秒経過で減速開始
      if (Date.now() - startTime >= 3000) {
        currentDelay += deceleration;
      }
      // 当選賞の区分が "A" の場合は maxDelay を 550 に設定、それ以外は 500
      const effectiveMaxDelay = (preselectedWinner && preselectedWinner.category === "A") ? 550 : 500;
      if (currentDelay >= effectiveMaxDelay) {
        running = false;
        clearTimeout(timerId);
        beep();
        finishAnimation();
        return;
      }
      timerId = setTimeout(animate, currentDelay);
    }
    
    async function recordWinner(winner) {
      try {
        await addDoc(collection(db, "history"), {
          prizeId: winner.id,
          prizeName: winner.name,
          rank: winner.rank,
          timestamp: new Date()
        });
      } catch (error) {
        console.error("履歴記録エラー:", error);
      }
    }
    
    async function finishAnimation() {
      if (!preselectedWinner) {
        document.getElementById("resultMessage").textContent = "抽選結果：当たる賞はありません。";
        document.getElementById("startBtn").style.visibility = "visible";
        return;
      }
      const tiles = document.querySelectorAll('.tile');
      let winnerIndex = -1;
      tiles.forEach((tile, i) => {
        if (tile.dataset.id === preselectedWinner.id) {
          winnerIndex = i;
        }
      });
      if (winnerIndex === -1) return;
      clearActive();
      tiles[winnerIndex].classList.add('active');
      await recordWinner(preselectedWinner);
      blinkWinnerTile(tiles[winnerIndex]);
    }
    
    function blinkWinnerTile(tile) {
      let blinkCount = 0;
      const interval = 200;
      const totalBlinks = 15;
      const blinkInterval = setInterval(() => {
        tile.classList.toggle("winner");
        blinkCount++;
        if (blinkCount >= totalBlinks) {
          clearInterval(blinkInterval);
          tile.classList.add("winner");
          // スタートボタン再表示（visibilityで表示）
          document.getElementById("startBtn").style.visibility = "visible";
        }
      }, interval);
      beep();
    }
    
    document.getElementById("startBtn").addEventListener("click", async () => {
      clearActive();
      await preselectWinner();
      if (!preselectedWinner) {
        alert("抽選対象となる賞がありません。");
        return;
      }
      // 賞区分 "A" の場合は、減速期間を通常より1秒延長（effectiveMaxDelayが550）
      if (preselectedWinner.category === "A") {
        deceleration = 17;  // 中間値
      } else {
        deceleration = 20;
      }
      // スタートボタンを隠す（visibilityで非表示）
      document.getElementById("startBtn").style.visibility = "hidden";
      running = true;
      currentDelay = 100;
      prevIndex = -1;
      document.getElementById("resultMessage").textContent = "";
      startTime = Date.now();
      animate();
    });
    
  </script>
</body>
</html>
